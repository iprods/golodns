image: golang:1.8-alpine

cache:
  paths:
    - .glide

before_script:
- apk add --no-cache git curl
- curl -s https://glide.sh/get | sh
- go-wrapper download
- glide install

stages:
- build
- release

test:
    stage: build
    script:
    - cd /go/src/github.com/iprods/golodns
    - go test $(go list ./... | grep -v '/vendor/') -v

build:
    stage: build
    script:
    - go build
    artifacts:
        name: "golodns_$CI_JOB_ID"
        paths:
        - golodns
        when: on_success

pre-release:
    stage: release
    script:
    - go build -ldflags "-w"
    artifacts:
        name: "golodns"
        paths:
        - golodns
        when: on_success
    when: manual
    only:
    - master
